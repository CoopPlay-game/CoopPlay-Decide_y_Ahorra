<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>CoopPlay - Supermercado: Entrevista</title>
  <style>
    :root{
      --ui-bg: rgba(12,12,16,0.94);
      --ui-accent: #ffd36a;
    }
    html,body{
      height:100%;
      margin:0;
      background:#000;
      color:#fff;
      font-family:'Courier New',monospace;
      overflow:hidden;
    }
    *{box-sizing:border-box;}

    #gameCanvas{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      image-rendering:pixelated;
    }

    #healthBars, #battleUI, #countdownOverlay, #specialWarning, #gameOverScreen, #victoryScreen{
      position:fixed;
      display:none;
      z-index:1000;
    }

    #healthBars{
      top:20px;
      left:50%;
      transform:translateX(-50%);
      width:90%;
      max-width:700px;
    }

    .health-container{
      margin-bottom:15px;
    }

    .health-bar-bg{
      width:100%;
      height:25px;
      background:#333;
      border:3px solid #fff;
      position:relative;
    }

    .health-bar-fill{
      height:100%;
      transition:width 0.3s ease;
    }

    .health-bar-fill.player{ background:linear-gradient(90deg, #ff0000, #ff6666); }
    .health-bar-fill.boss{ background:linear-gradient(90deg, #00ff00, #66ff66); }

    .health-text{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      font-size:12px;
      font-weight:bold;
      color:#fff;
      text-shadow:2px 2px 0 #000;
    }

    #battleUI{
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:90%;
      max-width:700px;
    }

    #questionBox{
      background:rgba(0,0,0,0.95);
      border:4px solid #fff;
      padding:20px;
    }

    #questionHeader{
      display:flex;
      justify-content:space-between;
      margin-bottom:15px;
    }

    #questionText{
      font-size:16px;
      color:#ffd36a;
      font-weight:bold;
      flex:1;
    }

    #questionTimer{
      font-size:24px;
      color:#ff0000;
      font-weight:bold;
    }

    #answerButtons{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .answer-btn{
      background:#333;
      border:3px solid #fff;
      color:#fff;
      padding:12px;
      cursor:pointer;
      font-size:14px;
    }

    .answer-btn:hover{ background:#555; }
    .answer-btn.correct{ background:#00ff00; color:#000; }
    .answer-btn.wrong{ background:#ff0000; }

    #countdownOverlay{
      inset:0;
      background:rgba(0,0,0,0.9);
      align-items:center;
      justify-content:center;
    }

    #countdownNumber{
      font-size:120px;
      color:#ffd36a;
      text-shadow:4px 4px 0 #000;
      animation:pulse 0.5s ease;
    }

    @keyframes pulse{
      0%{ transform:scale(0.5); opacity:0; }
      50%{ transform:scale(1.2); }
      100%{ transform:scale(1); opacity:1; }
    }

    #gameOverScreen, #victoryScreen{
      inset:0;
      background:rgba(0,0,0,0.95);
      align-items:center;
      justify-content:center;
    }

    .end-box{
      background:rgba(12,12,16,0.98);
      border:5px solid #ff0000;
      padding:40px;
      text-align:center;
      max-width:600px;
    }

    #victoryScreen .end-box{ border-color:#00ff00; }

    .end-box h1{
      font-size:48px;
      margin:0 0 20px 0;
    }

    #gameOverScreen h1{ color:#ff0000; }
    #victoryScreen h1{ color:#00ff00; }

    .game-btn{
      background:#ffd36a;
      border:3px solid #fff;
      color:#000;
      padding:15px 40px;
      margin:10px;
      cursor:pointer;
      font-size:18px;
      font-weight:bold;
    }

    .game-btn:hover{ transform:scale(1.1); }

    .coins-display{
      font-size:36px;
      color:#ffd700;
      margin:20px 0;
    }

    .stats-display{
      font-size:18px;
      margin:15px 0;
      color:#ccc;
    }

    #difficultyIndicator{
      position:fixed;
      top:100px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      border:3px solid #ffd36a;
      padding:10px 20px;
      font-size:16px;
      color:#ffd36a;
      z-index:1500;
      display:none;
    }
    /* CONTROLES M√ìVILES */
.mobile-btn{
  background:#2b2b2b;
  border:5px solid #e5c164;
  color:#ffd36a;
  font-size:24px;
  font-weight:bold;
  font-family:'Courier New',monospace;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
  pointer-events:auto;
  touch-action:none;
  box-shadow: 0 6px #6c4a00, inset 0 0 8px rgba(0,0,0,0.6);
  width:70px;
  height:70px;
  image-rendering:pixelated;
}

.mobile-btn:active{ 
  transform: translateY(2px); 
  box-shadow: 0 3px #6c4a00, inset 0 0 6px rgba(0,0,0,0.6); 
}

.mobile-btn.pressed{ 
  background:#1b1b1b; 
  border-color:#ffd36a; 
}

#mobileControls{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:200px;
  background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.6));
  z-index:2000;
  pointer-events:auto;
  display:none;
  align-items:flex-start;
  justify-content:space-between;
  padding:12px 16px;
  gap:12px;
}

#mobileControls.show{
  display:flex;
}

.mobile-left{
  position:relative;
  width:220px;
  height:100%;
  display:flex;
  align-items:flex-start;
  justify-content:flex-start;
}

.dpad {
  position:relative;
  width:160px;
  height:160px;
}

#btnW{ position:absolute; left:45px; top:6px; }
#btnA{ position:absolute; left:6px; top:58px; }
#btnS{ position:absolute; left:45px; top:58px; }
#btnD{ position:absolute; left:84px; top:58px; }

.mobile-right{
  position:relative;
  width:220px;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  justify-content:flex-start;
  gap:12px;
}

#btnE{ width:80px; height:80px; font-size:28px; }
#btnEnter{ width:140px; height:60px; font-size:18px; }

@media (max-width: 600px){
  #mobileControls{ height:180px; padding:8px; }
  .mobile-btn{ width:60px; height:60px; font-size:20px; border-width:4px; }
  #btnW{ left:42px; top:8px; }
  #btnA{ left:8px; top:54px; }
  #btnS{ left:42px; top:54px; }
  #btnD{ left:78px; top:54px; }
  #btnE{ width:70px; height:70px; font-size:26px; }
  #btnEnter{ width:120px; height:50px; font-size:16px; }
}
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="healthBars">
    <div class="health-container">
      <div style="margin-bottom:5px;">üíº GERENTE</div>
      <div class="health-bar-bg">
        <div class="health-bar-fill boss" id="bossHealthBar" style="width:100%">
          <div class="health-text" id="bossHealthText">300/300</div>
        </div>
      </div>
    </div>
    <div class="health-container">
      <div style="margin-bottom:5px;">‚ù§Ô∏è TU SALUD</div>
      <div class="health-bar-bg">
        <div class="health-bar-fill player" id="playerHealthBar" style="width:100%">
          <div class="health-text" id="playerHealthText">100/100</div>
        </div>
      </div>
    </div>
  </div>

  <div id="difficultyIndicator">NIVEL: 1</div>

  <div id="battleUI">
    <div id="questionBox">
      <div id="questionHeader">
        <div id="questionText"></div>
        <div id="questionTimer">‚è±Ô∏è 7</div>
      </div>
      <div id="answerButtons"></div>
    </div>
  </div>

  <div id="countdownOverlay">
    <div id="countdownNumber">3</div>
  </div>

  <div id="specialWarning" style="position:fixed;top:30%;left:50%;transform:translate(-50%,-50%);background:rgba(255,0,0,0.95);border:5px solid #fff;padding:30px;display:none;z-index:500;text-align:center;font-size:24px;">
    üö® C√çRCULO EXPANSIVO üö®<br>
    <span style="font-size:18px;">¬°Ve al c√≠rculo VERDE!</span>
  </div>

  <div id="gameOverScreen">
    <div class="end-box">
      <h1>üíÄ GAME OVER</h1>
      <p>Has perdido la entrevista</p>
      <div class="stats-display" id="finalStats"></div>
      <button class="game-btn" onclick="retryBattle()">üîÑ Reintentar</button>
      <button class="game-btn" onclick="exitToMenu()">üö™ Men√∫</button>
    </div>
  </div>

  <div id="victoryScreen">
    <div class="end-box">
      <h1>üéâ ¬°VICTORIA!</h1>
      <p>¬°Pasaste la entrevista!</p>
      <div class="coins-display" id="coinsEarned">üí∞ +250</div>
      <div class="stats-display" id="victoryStats"></div>
      <button class="game-btn" onclick="exitToMenu()">‚ú® Continuar</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    let W = window.innerWidth;
    let H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;

    window.addEventListener('resize', () => {
      W = window.innerWidth;
      H = window.innerHeight;
      canvas.width = W;
      canvas.height = H;
    });

    let gameState = 'exploration';
    let battlePhase = 'waiting';

    // SISTEMA DE DIFICULTAD DIN√ÅMICA
    let difficultyLevel = 1;
    let correctAnswers = 0;
    let totalQuestions = 20;

    function getDifficultyStats(){
      const level = Math.min(10, difficultyLevel);
      return {
        spawnRate: Math.max(18, 30 - level * 1.0),
        speed: 0.6 + level * 0.05,
        damage: 0.5 + level * 0.04,
        bossHP: 200 + level * 10
      };
    }

    let playerStats = { hp: 100, maxHP: 100 };
    let bossStats = { hp: 300, maxHP: 300 };

    let player = {
      x: 200, y: 500, w: 28, h: 48, speed: 3,
      facing: 'right', walkCycle: 0, isWalking: false,
      colors: { skin: '#F1C27D', hair: '#2F1B14', shirt: '#4169E1', pants: '#000080', shoes: '#000000' }
    };

    let boss = {
      x: 900, y: 500, w: 70, h: 100, canTalk: true,
      colors: { skin: '#F1C27D', hair: '#4A4A4A', shirt: '#2C2C2C', pants: '#2C2C2C', shoes: '#000000' },
      battleX: 0, battleY: 150, animFrame: 0
    };

    let soul = { x: 0, y: 0, size: 20, speed: 5, lastX: 0, lastY: 0, isMoving: false };

    let battleBox = { x: 0, y: 0, w: 420, h: 260 };
    let projectiles = [];
    let attackTimer = 0;
    let specialActive = false;
    let specialTimer = 0;
    let expandCircle = null;
    let safeZone = null;
    let screenFlash = 0;

    let countdownActive = false;
    let countdownTimer = 180;

    const questions = [
      { q: "¬øPor qu√© quieres trabajar aqu√≠?", a: ["Necesito dinero", "Me gusta la cultura empresarial", "No tengo opciones", "Est√° cerca"], c: 1 },
      { q: "¬øCu√°l es tu mayor fortaleza?", a: ["Soy puntual", "No tengo debilidades", "Solo trabajo supervisado", "Hago lo m√≠nimo"], c: 0 },
      { q: "¬øD√≥nde te ves en 5 a√±os?", a: ["No lo s√©", "En otra empresa", "Creciendo aqu√≠", "Jubilado"], c: 2 },
      { q: "¬øC√≥mo manejas el estr√©s?", a: ["Me rindo", "Organizo y respiro", "Culpo a otros", "Lo ignoro"], c: 1 },
      { q: "¬øPor qu√© dejaste tu √∫ltimo trabajo?", a: ["Odiaba a mi jefe", "Buscaba nuevos retos", "Me despidieron", "Mal pago"], c: 1 },
      { q: "¬øC√≥mo trabajas en equipo?", a: ["Prefiero solo", "Escucho y colaboro", "Solo doy √≥rdenes", "Mi parte y ya"], c: 1 },
      { q: "¬øQu√© haces ante un conflicto?", a: ["Lo ignoro", "Hablo y resuelvo", "Me quejo", "Dejo el trabajo"], c: 1 },
      { q: "¬øCu√°l es tu debilidad?", a: ["Soy perfeccionista", "Llego tarde", "No tengo", "No me gusta trabajar"], c: 0 },
      { q: "¬øQu√© te motiva?", a: ["Solo dinero", "Aprender y crecer", "Horario de salida", "Vacaciones"], c: 1 },
      { q: "¬øC√≥mo priorizas tareas?", a: ["Lo m√°s f√°cil", "Urgente e importante", "Lo que me gusta", "No priorizo"], c: 1 },
      { q: "¬øAceptas cr√≠ticas?", a: ["Me ofendo", "S√≠, aprendo", "Depende de qui√©n", "No acepto"], c: 1 },
      { q: "¬øQu√© haces si no sabes algo?", a: ["Lo invento", "Pregunto y aprendo", "Lo ignoro", "Culpo a otros"], c: 1 },
      { q: "¬øTu √©tica laboral?", a: ["Lo m√≠nimo", "Responsable", "Solo cuando me ven", "Irregular"], c: 1 },
      { q: "¬øCompa√±ero robando?", a: ["No es mi problema", "Lo reporto", "Pido mi parte", "Lo amenazo"], c: 1 },
      { q: "¬øTrabajar bajo presi√≥n?", a: ["Me estreso mucho", "S√≠, rindo mejor", "Solo con pago extra", "Nunca"], c: 1 },
      { q: "¬øCalidad o velocidad?", a: ["Velocidad", "Balance", "Calidad sin l√≠mite", "Ninguna"], c: 1 },
      { q: "¬øMantenerte actualizado?", a: ["No me interesa", "Leo y practico", "Solo lo que ense√±an", "Pregunto"], c: 1 },
      { q: "¬øCliente dif√≠cil?", a: ["Lo ignoro", "Escucho y soluciono", "Le grito", "Lo transfiero"], c: 1 },
      { q: "¬øFlexible con horarios?", a: ["No", "S√≠, cuando necesario", "Solo con pago extra", "Nunca"], c: 1 },
      { q: "¬øError propio?", a: ["Culpo a otros", "Lo admito y corrijo", "Lo oculto", "Me justifico"], c: 1 },
      { q: "¬øM√∫ltiples tareas?", a: ["Me abrumo", "Organizo y priorizo", "Todo a medias", "Delego todo"], c: 1 },
      { q: "¬øQu√© esperas del jefe?", a: ["Que me deje solo", "Comunicaci√≥n y apoyo", "Que no moleste", "Solo sueldo"], c: 1 },
      { q: "¬øAmbiente laboral?", a: ["No importa", "Soy positivo", "Mi trabajo y ya", "Critico a todos"], c: 1 },
      { q: "¬øSin ascenso?", a: ["Renuncio", "Pregunto qu√© mejorar", "Me quejo", "Trabajo menos"], c: 1 },
      { q: "¬øSalario o ambiente?", a: ["Solo salario", "Ambos importantes", "Solo ambiente", "Ninguno"], c: 1 },
      { q: "¬øDemuestras iniciativa?", a: ["Espero instrucciones", "Propongo mejoras", "Solo mi trabajo", "No demuestro"], c: 1 },
      { q: "¬øTiempo libre en trabajo?", a: ["Redes sociales", "Busco tareas", "Converso", "Duermo"], c: 1 },
      { q: "¬øCambios repentinos?", a: ["Me resisto", "Me adapto", "Me quejo", "Ignoro"], c: 1 },
      { q: "¬øBuen empleado?", a: ["Llegar a tiempo", "Responsabilidad", "Lo m√≠nimo", "No causar problemas"], c: 1 },
      { q: "¬øPor qu√© contratarte?", a: ["Necesito trabajo", "Tengo habilidades", "Soy el √∫nico", "No s√©"], c: 1 }
    ];

    let usedQuestions = [];
    let currentQ = null;
    let qAnswered = 0;
    let qTimer = 0;
    let qInterval = null;

    let keys = {};
    document.addEventListener('keydown', (e) => {
      keys[e.key.toLowerCase()] = true;
      keys[e.key] = true;
      if(e.key === 'e' && gameState === 'exploration') checkBossInteraction();
    });
    document.addEventListener('keyup', (e) => {
      keys[e.key.toLowerCase()] = false;
      keys[e.key] = false;
    });

    function toHex(n){ return n.toString(16).padStart(2,'0'); }
    function adjustColor(c, f){
      let r=parseInt(c.substr(1,2),16), g=parseInt(c.substr(3,2),16), b=parseInt(c.substr(5,2),16);
      if(f>0){ r=Math.min(255,Math.floor(r+(255-r)*f)); g=Math.min(255,Math.floor(g+(255-g)*f)); b=Math.min(255,Math.floor(b+(255-b)*f)); }
      else{ const x=1+f; r=Math.max(0,Math.floor(r*x)); g=Math.max(0,Math.floor(g*x)); b=Math.max(0,Math.floor(b*x)); }
      return '#'+toHex(r)+toHex(g)+toHex(b);
    }
    function lighten(c,f){ return adjustColor(c,f); }
    function darken(c,f){ return adjustColor(c,-f); }
    
    function drawRect(ctx,x,y,w,h,c){
      ctx.fillStyle=c; ctx.fillRect(x,y,w,h);
      const l=lighten(c,0.25), d=darken(c,0.25);
      const lw=Math.floor(w*0.2), th=Math.floor(h*0.2);
      ctx.fillStyle=l; ctx.fillRect(x,y,w,th); ctx.fillRect(x,y,lw,h);
      ctx.fillStyle=d; ctx.fillRect(x,y+h-th,w,th); ctx.fillRect(x+w-lw,y,lw,h);
    }

    function drawChar(ctx,x,y,colors,scale=1){
      ctx.save();
      ctx.translate(x,y);
      ctx.scale(scale,scale);
      
      drawRect(ctx,6,-2,16,8,colors.hair);
      drawRect(ctx,7,0,14,12,colors.skin);
      ctx.fillStyle='#fff'; ctx.fillRect(10,4,3,2); ctx.fillRect(15,4,3,2);
      ctx.fillStyle='#000'; ctx.fillRect(11,4,1,1); ctx.fillRect(16,4,1,1);
      ctx.fillStyle='#652d2d'; ctx.fillRect(12,8,4,1);
      drawRect(ctx,6,12,16,12,colors.shirt);
      drawRect(ctx,1,12,6,6,colors.shirt);
      drawRect(ctx,21,12,6,6,colors.shirt);
      drawRect(ctx,1,18,6,6,colors.skin);
      drawRect(ctx,21,18,6,6,colors.skin);
      drawRect(ctx,7,24,14,8,colors.pants);
      drawRect(ctx,5,32,8,4,colors.shoes);
      drawRect(ctx,15,32,8,4,colors.shoes);
      
      ctx.restore();
    }

    function checkBossInteraction(){
      const dist = Math.hypot(player.x - (boss.x + 50), player.y - (boss.y + 50));
      if(dist < 200 && boss.canTalk){
        boss.canTalk = false;
        startBattle();
      }
    }

    function startBattle(){
      gameState = 'battle';
      battlePhase = 'waiting';
      
      const stats = getDifficultyStats();
      bossStats.maxHP = stats.bossHP;
      bossStats.hp = stats.bossHP;
      
      document.getElementById('healthBars').style.display = 'block';
      document.getElementById('difficultyIndicator').style.display = 'block';
      updateDifficultyIndicator();
      
      battleBox.x = W/2 - battleBox.w/2;
      battleBox.y = H/2 - battleBox.h/2 + 50;
      
      soul.x = battleBox.x + battleBox.w/2;
      soul.y = battleBox.y + battleBox.h/2;
      soul.lastX = soul.x;
      soul.lastY = soul.y;
      
      boss.battleX = W/2;
      boss.battleY = 150;
      
      updateHealthBars();
      startCountdown();
    }

    function updateDifficultyIndicator(){
      document.getElementById('difficultyIndicator').textContent = `NIVEL: ${difficultyLevel}`;
    }

    function startCountdown(){
      countdownActive = true;
      countdownTimer = 180;
      document.getElementById('countdownOverlay').style.display = 'flex';
    }

    function updateCountdown(){
      if(!countdownActive) return;
      
      countdownTimer--;
      const sec = Math.ceil(countdownTimer/60);
      const el = document.getElementById('countdownNumber');
      
      if(sec > 0){
        el.textContent = sec;
        el.style.animation = 'none';
        setTimeout(() => el.style.animation = 'pulse 0.5s ease', 10);
      } else if(countdownTimer === 0){
        el.textContent = '¬°GO!';
        el.style.animation = 'pulse 0.5s ease';
      } else if(countdownTimer < -30){
        document.getElementById('countdownOverlay').style.display = 'none';
        countdownActive = false;
        battlePhase = 'attacking';
        startAttackPhase();
      }
    }

    function startAttackPhase(){
      battlePhase = 'attacking';
      document.getElementById('battleUI').style.display = 'none';
      attackTimer = 600;
      specialActive = false;
      expandCircle = null;
      safeZone = null;
      document.getElementById('specialWarning').style.display = 'none';
    }

    function startAnswerPhase(){
      battlePhase = 'answering';
      projectiles = [];
      expandCircle = null;
      safeZone = null;
      showQuestion();
    }

    function showQuestion(){
      if(qAnswered >= totalQuestions){
        endBattle(true);
        return;
      }
      
      let avail = questions.filter((q,i) => !usedQuestions.includes(i));
      if(avail.length === 0){
        usedQuestions = [];
        avail = questions;
      }
      
      const idx = Math.floor(Math.random() * avail.length);
      currentQ = avail[idx];
      usedQuestions.push(questions.indexOf(currentQ));
      
      const shuffled = currentQ.a.map((text,i) => ({text, correct: i===currentQ.c})).sort(() => Math.random()-0.5);
      
      document.getElementById('battleUI').style.display = 'block';
      document.getElementById('questionText').textContent = currentQ.q;
      
      const btns = document.getElementById('answerButtons');
      btns.innerHTML = '';
      
      shuffled.forEach(ans => {
  const btn = document.createElement('button');
  btn.className = 'answer-btn';
  btn.textContent = ans.text;
  
  // Hacer funcionar tanto en PC como m√≥vil
  btn.onclick = () => selectAnswer(ans.correct, btn);
  btn.ontouchstart = (e) => {
    e.preventDefault();
    selectAnswer(ans.correct, btn);
  };
  
  btns.appendChild(btn);
});

      
      qTimer = 420;
      updateTimer();
      
      if(qInterval) clearInterval(qInterval);
      qInterval = setInterval(() => {
        qTimer--;
        updateTimer();
        if(qTimer <= 0){
          clearInterval(qInterval);
          timeoutAnswer();
        }
      }, 1000/60);
    }

    function updateTimer(){
      const sec = Math.ceil(qTimer/60);
      document.getElementById('questionTimer').textContent = `‚è±Ô∏è ${sec}`;
    }

    function timeoutAnswer(){
      if(battlePhase !== 'answering') return;
      
      document.querySelectorAll('.answer-btn').forEach(b => b.style.pointerEvents = 'none');
      
      const stats = getDifficultyStats();
      damage(playerStats, 15 * stats.damage);
      
      setTimeout(() => {
        if(playerStats.hp <= 0) endBattle(false);
        else startAttackPhase();
      }, 1500);
    }

    function selectAnswer(correct, btn){
      if(qInterval) clearInterval(qInterval);
      qAnswered++;
      
      document.querySelectorAll('.answer-btn').forEach(b => b.style.pointerEvents = 'none');
      
      if(correct){
        btn.classList.add('correct');
        correctAnswers++;
        
        // AUMENTAR DIFICULTAD
        if(correctAnswers % 2 === 0){
          difficultyLevel++;
          updateDifficultyIndicator();
          
          const stats = getDifficultyStats();
          bossStats.maxHP = stats.bossHP;
          if(bossStats.hp < bossStats.maxHP){
            bossStats.hp = Math.min(bossStats.maxHP, bossStats.hp + 20);
          }
        }
        
        damage(bossStats, 25);
        heal(playerStats, 8);
        
        setTimeout(() => {
          if(bossStats.hp <= 0) endBattle(true);
          else startAttackPhase();
        }, 1500);
      } else {
        btn.classList.add('wrong');
        const stats = getDifficultyStats();
        damage(playerStats, 12 * stats.damage);
        
        setTimeout(() => {
          if(playerStats.hp <= 0) endBattle(false);
          else startAttackPhase();
        }, 1500);
      }
    }

    function damage(entity, amt){
      entity.hp = Math.max(0, entity.hp - amt);
      updateHealthBars();
    }

    function heal(entity, amt){
      entity.hp = Math.min(entity.maxHP, entity.hp + amt);
      updateHealthBars();
    }

    function updateHealthBars(){
      const bp = (bossStats.hp / bossStats.maxHP) * 100;
      document.getElementById('bossHealthBar').style.width = bp + '%';
      document.getElementById('bossHealthText').textContent = `${Math.round(bossStats.hp)}/${bossStats.maxHP}`;
      
      const pp = (playerStats.hp / playerStats.maxHP) * 100;
      document.getElementById('playerHealthBar').style.width = pp + '%';
      document.getElementById('playerHealthText').textContent = `${Math.round(playerStats.hp)}/${playerStats.maxHP}`;
    }

    function endBattle(victory){
      gameState = victory ? 'victory' : 'defeat';
      document.getElementById('healthBars').style.display = 'none';
      document.getElementById('battleUI').style.display = 'none';
      document.getElementById('difficultyIndicator').style.display = 'none';
      
      if(victory){
        const coins = 150 + correctAnswers * 10;
        document.getElementById('coinsEarned').textContent = `üí∞ +${coins} Monedas`;
        document.getElementById('victoryStats').innerHTML = `
          Respuestas correctas: ${correctAnswers}/${qAnswered}<br>
          Nivel m√°ximo alcanzado: ${difficultyLevel}
        `;
        document.getElementById('victoryScreen').style.display = 'flex';
      } else {
        document.getElementById('finalStats').innerHTML = `
          Respuestas correctas: ${correctAnswers}/${qAnswered}<br>
          Nivel alcanzado: ${difficultyLevel}
        `;
        document.getElementById('gameOverScreen').style.display = 'flex';
      }
    }

    function retryBattle(){
      document.getElementById('gameOverScreen').style.display = 'none';
      playerStats.hp = playerStats.maxHP;
      bossStats.hp = bossStats.maxHP;
      qAnswered = 0;
      correctAnswers = 0;
      difficultyLevel = 1;
      usedQuestions = [];
      projectiles = [];
      updateHealthBars();
      startBattle();
    }

    function exitToMenu(){
      window.location.reload();
    }

    function updateAttacks(){
      if(battlePhase !== 'attacking') return;
      
      attackTimer--;
      const stats = getDifficultyStats();
      
      // ONDA DE CHOQUE ALEATORIA (12% de chance cuando no est√° activa)
      if(!specialActive && attackTimer > 0 && Math.random() < 0.0015){
        specialActive = true;
        specialTimer = 420;
        
        const sx = battleBox.x + 60 + Math.random() * (battleBox.w - 120);
        const sy = battleBox.y + 60 + Math.random() * (battleBox.h - 120);
        safeZone = { x: sx, y: sy, r: 35 };
        
        document.getElementById('specialWarning').style.display = 'block';
        
        setTimeout(() => {
          if(specialActive){
            expandCircle = {
              x: boss.battleX,
              y: boss.battleY + 50,
              r: 0,
              maxR: Math.max(W, H),
              speed: 5 + stats.speed * 2
            };
          }
        }, 2500);
      }
      
      if(specialActive){
        specialTimer--;
        screenFlash = (screenFlash + 1) % 20;
        
        if(expandCircle){
          expandCircle.r += expandCircle.speed;
          
          const dist = Math.hypot(soul.x - soul.lastX, soul.y - soul.lastY);
          if(dist > 1) soul.isMoving = true;
          
          const distToSafe = Math.hypot(soul.x - safeZone.x, soul.y - safeZone.y);
          const inSafe = distToSafe < safeZone.r;
          
          const distToCenter = Math.hypot(soul.x - expandCircle.x, soul.y - expandCircle.y);
          
          if(Math.abs(distToCenter - expandCircle.r) < 25 && soul.isMoving && !inSafe){
            damage(playerStats, 25 * stats.damage);
            soul.isMoving = false;
            if(playerStats.hp <= 0) endBattle(false);
          }
        }
        
        if(specialTimer <= 0){
          specialActive = false;
          expandCircle = null;
          safeZone = null;
          document.getElementById('specialWarning').style.display = 'none';
          screenFlash = 0;
          soul.isMoving = false;
        }
      }
      
      soul.lastX = soul.x;
      soul.lastY = soul.y;
      
      // SPAWN DE ATAQUES NORMALES
      const currentSpawnRate = Math.floor(stats.spawnRate);
      if(attackTimer > 0 && attackTimer % currentSpawnRate === 0){
        const r = Math.random();
        if(r < 0.2) spawnPaper();
        else if(r < 0.35) spawnDesk();
        else if(r < 0.5) spawnComputer();
        else if(r < 0.65) spawnClock();
        else if(r < 0.8) spawnCoffee();
        else if(r < 0.93) spawnLightning();
        else spawnMedkit();
      }
      
      if(attackTimer <= 0) startAnswerPhase();
      
      for(let i = projectiles.length - 1; i >= 0; i--){
        const p = projectiles[i];
        
        if(p.type === 'paper'){ p.y += p.vy; p.rot += 0.15; }
        else if(p.type === 'lightning'){ p.x += p.vx; p.y += p.vy; p.flash = (p.flash + 1) % 8; }
        else if(p.type === 'clock'){ p.x += p.vx; p.y += p.vy; p.rot += 0.08; }
        else if(p.type === 'desk'){ p.y += p.vy; p.rot += 0.05; }
        else if(p.type === 'computer'){ p.x += p.vx; p.y += p.vy; }
        else if(p.type === 'coffee'){ p.y += p.vy; p.rot += 0.1; }
        else if(p.type === 'medkit'){ p.y += p.vy; p.pulse = (p.pulse + 0.1) % (Math.PI*2); }
        
        if(p.y > battleBox.y + battleBox.h + 100 || p.y < battleBox.y - 100 || 
           p.x > battleBox.x + battleBox.w + 100 || p.x < battleBox.x - 100){
          projectiles.splice(i, 1);
          continue;
        }
        
        if(checkCollision(p, soul)){
          // Verificar si est√° en zona segura
          let inSafeZone = false;
          if(safeZone){
            const distToSafe = Math.hypot(soul.x - safeZone.x, soul.y - safeZone.y);
            inSafeZone = distToSafe < safeZone.r;
          }
          
          if(p.type === 'medkit'){
            heal(playerStats, 6);
          } else if(!inSafeZone){
            // Solo hacer da√±o si NO est√° en zona segura
            damage(playerStats, p.dmg);
            if(playerStats.hp <= 0) endBattle(false);
          }
          projectiles.splice(i, 1);
        }
      }
    }

    function spawnPaper(){
      const stats = getDifficultyStats();
      projectiles.push({
        type: 'paper',
        x: battleBox.x + Math.random() * battleBox.w,
        y: battleBox.y - 30,
        w: 28, h: 36,
        vy: (5 + Math.random() * 3) * stats.speed,
        rot: Math.random() * Math.PI * 2,
        dmg: 5 * stats.damage
      });
    }

    function spawnLightning(){
      const stats = getDifficultyStats();
      const dir = Math.floor(Math.random() * 8);
      let x, y, vx, vy, w, h;
      
      if(dir === 0){ x = battleBox.x + Math.random() * battleBox.w; y = battleBox.y - 70; vx = 0; vy = 12; w = 24; h = 70; }
      else if(dir === 1){ x = battleBox.x - 70; y = battleBox.y + Math.random() * battleBox.h; vx = 12; vy = 0; w = 70; h = 24; }
      else if(dir === 2){ x = battleBox.x + battleBox.w + 70; y = battleBox.y + Math.random() * battleBox.h; vx = -12; vy = 0; w = 70; h = 24; }
      else if(dir === 3){ x = battleBox.x + Math.random() * battleBox.w; y = battleBox.y + battleBox.h + 70; vx = 0; vy = -12; w = 24; h = 70; }
      else if(dir === 4){ x = battleBox.x - 50; y = battleBox.y - 50; vx = 9; vy = 9; w = 50; h = 50; }
      else if(dir === 5){ x = battleBox.x + battleBox.w + 50; y = battleBox.y - 50; vx = -9; vy = 9; w = 50; h = 50; }
      else if(dir === 6){ x = battleBox.x - 50; y = battleBox.y + battleBox.h + 50; vx = 9; vy = -9; w = 50; h = 50; }
      else{ x = battleBox.x + battleBox.w + 50; y = battleBox.y + battleBox.h + 50; vx = -9; vy = -9; w = 50; h = 50; }
      
      projectiles.push({
        type: 'lightning',
        x, y, w, h,
        vx: vx * stats.speed,
        vy: vy * stats.speed,
        flash: 0,
        dir,
        dmg: 6 * stats.damage
      });
    }

    function spawnClock(){
      const stats = getDifficultyStats();
      const side = Math.random() > 0.5;
      projectiles.push({
        type: 'clock',
        x: side ? battleBox.x - 35 : battleBox.x + battleBox.w + 35,
        y: battleBox.y + Math.random() * battleBox.h,
        w: 32, h: 32,
        vx: (side ? 6 : -6) * stats.speed,
        vy: (Math.random() - 0.5) * 4 * stats.speed,
        rot: 0,
        dmg: 7 * stats.damage
      });
    }

    function spawnDesk(){
      const stats = getDifficultyStats();
      projectiles.push({
        type: 'desk',
        x: battleBox.x + Math.random() * battleBox.w,
        y: battleBox.y - 50,
        w: 60, h: 40,
        vy: (4 + Math.random() * 2.5) * stats.speed,
        rot: 0,
        dmg: 8 * stats.damage
      });
    }

    function spawnComputer(){
      const stats = getDifficultyStats();
      const side = Math.random() > 0.5;
      projectiles.push({
        type: 'computer',
        x: side ? battleBox.x - 40 : battleBox.x + battleBox.w + 40,
        y: battleBox.y + Math.random() * (battleBox.h - 50),
        w: 48, h: 40,
        vx: (side ? 6 : -6) * stats.speed,
        vy: (Math.random() - 0.5) * 3 * stats.speed,
        dmg: 7 * stats.damage
      });
    }

    function spawnCoffee(){
      const stats = getDifficultyStats();
      projectiles.push({
        type: 'coffee',
        x: battleBox.x + Math.random() * battleBox.w,
        y: battleBox.y - 40,
        w: 24, h: 32,
        vy: (6 + Math.random() * 3) * stats.speed,
        rot: 0,
        dmg: 6 * stats.damage
      });
    }

    function spawnMedkit(){
      const stats = getDifficultyStats();
      projectiles.push({
        type: 'medkit',
        x: battleBox.x + Math.random() * battleBox.w,
        y: battleBox.y - 35,
        w: 32, h: 32,
        vy: 3 * stats.speed,
        pulse: 0,
        dmg: 0
      });
    }

    function checkCollision(p, s){
      const scx = s.x, scy = s.y, sr = s.size / 2;
      const pcx = p.x + p.w / 2, pcy = p.y + p.h / 2;
      const dx = scx - pcx, dy = scy - pcy;
      const dist = Math.sqrt(dx*dx + dy*dy);
      return dist < (sr + Math.min(p.w, p.h) / 2.5);
    }

    function updatePlayer(){
      if(gameState !== 'exploration') return;
      
      let dx = 0, dy = 0;
      if(keys['w'] || keys['arrowup']) dy -= player.speed;
      if(keys['s'] || keys['arrowdown']) dy += player.speed;
      if(keys['a'] || keys['arrowleft']) dx -= player.speed;
      if(keys['d'] || keys['arrowright']) dx += player.speed;
      
      player.isWalking = dx !== 0 || dy !== 0;
      if(player.isWalking) player.walkCycle += 0.25;
      
      const nx = player.x + dx, ny = player.y + dy;
      
      // Colisi√≥n reducida con el jefe (solo el centro)
      const bossCenterX = boss.x + 50;
      const bossCenterY = boss.y + 50;
      const distToBoss = Math.hypot(nx - bossCenterX, ny - bossCenterY);
      const collide = distToBoss < 40;
      
      if(!collide){
        player.x = Math.max(50, Math.min(W - 50, nx));
        player.y = Math.max(H * 0.4, Math.min(H - 50, ny));
      }
    }

    function updateSoul(){
      if(gameState !== 'battle' || battlePhase !== 'attacking') return;
      
      let dx = 0, dy = 0;
      if(keys['ArrowUp'] || keys['w']) dy -= soul.speed;
      if(keys['ArrowDown'] || keys['s']) dy += soul.speed;
      if(keys['ArrowLeft'] || keys['a']) dx -= soul.speed;
      if(keys['ArrowRight'] || keys['d']) dx += soul.speed;
      
      if(dx !== 0 && dy !== 0){
        dx *= 0.707;
        dy *= 0.707;
      }
      
      soul.x += dx;
      soul.y += dy;
      
      soul.x = Math.max(battleBox.x + soul.size/2, Math.min(battleBox.x + battleBox.w - soul.size/2, soul.x));
      soul.y = Math.max(battleBox.y + soul.size/2, Math.min(battleBox.y + battleBox.h - soul.size/2, soul.y));
    }

    function draw(){
      ctx.clearRect(0, 0, W, H);
      
      if(gameState === 'exploration'){
        drawExploration();
      } else if(gameState === 'battle'){
        drawBattle();
      }
    }

    function drawExploration(){
      const grad = ctx.createLinearGradient(0, 0, 0, H * 0.4);
      grad.addColorStop(0, '#87CEEB');
      grad.addColorStop(1, '#B0D8F0');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H * 0.4);
      
      ctx.fillStyle = '#505050';
      ctx.fillRect(0, H * 0.4, W, H * 0.6);
      
      const by = H * 0.2, bh = H * 0.6;
      ctx.fillStyle = '#8B8B8B';
      ctx.fillRect(W * 0.15, by, W * 0.7, bh);
      
      ctx.fillStyle = '#6B8E53';
      ctx.fillRect(W * 0.18, by + 20, W * 0.64, 100);
      ctx.strokeStyle = '#8B4513';
      ctx.lineWidth = 6;
      ctx.strokeRect(W * 0.18, by + 20, W * 0.64, 100);
      
      ctx.fillStyle = '#8B4513';
      ctx.font = 'bold 60px Courier New';
      ctx.textAlign = 'center';
      ctx.fillText('MARKET', W / 2, by + 85);
      
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 24px Courier New';
      ctx.fillText('24 HRS', W * 0.75, by + 80);
      
      const wy = by + 140;
      for(let i = 0; i < 7; i++){
        const x = W * 0.2 + i * 90;
        ctx.fillStyle = '#4169E1';
        ctx.fillRect(x, wy, 70, 180);
        ctx.strokeStyle = '#2C2C2C';
        ctx.lineWidth = 4;
        ctx.strokeRect(x, wy, 70, 180);
      }
      
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.beginPath();
      ctx.ellipse(player.x, player.y + player.h - 10, player.w * 0.5, 10, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.beginPath();
      ctx.ellipse(boss.x + boss.w/2, boss.y + boss.h - 5, boss.w * 0.5, 12, 0, 0, Math.PI * 2);
      ctx.fill();
      
      const legSwing = player.isWalking ? Math.sin(player.walkCycle) * 5 : 0;
      const armSwing = player.isWalking ? Math.sin(player.walkCycle + Math.PI) * 3 : 0;
      const bob = player.isWalking ? Math.abs(Math.sin(player.walkCycle)) * 2 : 0;
      
      ctx.save();
      ctx.translate(player.x - 14, player.y - 48 - bob);
      
      drawRect(ctx,6,-2,16,8,player.colors.hair);
      drawRect(ctx,7,0,14,12,player.colors.skin);
      ctx.fillStyle='#fff'; ctx.fillRect(10,4,3,2); ctx.fillRect(15,4,3,2);
      ctx.fillStyle='#000'; ctx.fillRect(11,4,1,1); ctx.fillRect(16,4,1,1);
      ctx.fillStyle='#652d2d'; ctx.fillRect(12,8,4,1);
      drawRect(ctx,6,12,16,12,player.colors.shirt);
      drawRect(ctx,1,12+armSwing,6,6,player.colors.shirt);
      drawRect(ctx,21,12-armSwing,6,6,player.colors.shirt);
      drawRect(ctx,1,18+armSwing,6,6,player.colors.skin);
      drawRect(ctx,21,18-armSwing,6,6,player.colors.skin);
      drawRect(ctx,7,24,14,8,player.colors.pants);
      drawRect(ctx,5,32+legSwing,8,4,player.colors.shoes);
      drawRect(ctx,15,32-legSwing,8,4,player.colors.shoes);
      
      ctx.restore();
      
      // ======= JEFE - SE DIBUJA AL FINAL PARA QUE SEA VISIBLE =======
      const bossScale = 3.5;
      ctx.save();
      ctx.translate(boss.x, boss.y);
      ctx.scale(bossScale, bossScale);
      
      // Cabello
      ctx.fillStyle = boss.colors.hair;
      ctx.fillRect(6, -2, 16, 8);
      
      // Cara
      ctx.fillStyle = boss.colors.skin;
      ctx.fillRect(7, 0, 14, 12);
      
      // Ojos
      ctx.fillStyle = '#fff';
      ctx.fillRect(10, 4, 3, 2);
      ctx.fillRect(15, 4, 3, 2);
      ctx.fillStyle = '#000';
      ctx.fillRect(11, 4, 1, 1);
      ctx.fillRect(16, 4, 1, 1);
      
      // Boca
      ctx.fillStyle = '#652d2d';
      ctx.fillRect(12, 8, 4, 1);
      
      // Camisa
      ctx.fillStyle = boss.colors.shirt;
      ctx.fillRect(6, 12, 16, 12);
      
      // Brazos
      ctx.fillRect(1, 12, 6, 6);
      ctx.fillRect(21, 12, 6, 6);
      
      // Manos
      ctx.fillStyle = boss.colors.skin;
      ctx.fillRect(1, 18, 6, 6);
      ctx.fillRect(21, 18, 6, 6);
      
      // Pantalones
      ctx.fillStyle = boss.colors.pants;
      ctx.fillRect(7, 24, 14, 8);
      
      // Zapatos
      ctx.fillStyle = boss.colors.shoes;
      ctx.fillRect(5, 32, 8, 4);
      ctx.fillRect(15, 32, 8, 4);
      
      // Corbata roja
      ctx.fillStyle = '#8B0000';
      ctx.fillRect(12, 12, 4, 12);
      
      ctx.restore();
      
      // Indicador de interacci√≥n
      if(boss.canTalk && Math.hypot(player.x - (boss.x + boss.w/2), player.y - (boss.y + boss.h/2)) < 200){
        ctx.fillStyle = 'rgba(255, 215, 0, 0.95)';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.font = 'bold 28px Courier New';
        ctx.textAlign = 'center';
        ctx.strokeText('¬°Presiona E!', boss.x + 50, boss.y - 30);
        ctx.fillText('¬°Presiona E!', boss.x + 50, boss.y - 30);
      }
    }

    function drawBattle(){
      if(specialActive){
        const alpha = screenFlash < 10 ? 0.3 : 0.1;
        ctx.fillStyle = `rgba(255, 0, 0, ${alpha})`;
        ctx.fillRect(0, 0, W, H);
      } else {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
        ctx.fillRect(0, 0, W, H);
      }
      
      ctx.fillStyle = '#000';
      ctx.fillRect(battleBox.x, battleBox.y, battleBox.w, battleBox.h);
      ctx.strokeStyle = '#FFF';
      ctx.lineWidth = 5;
      ctx.strokeRect(battleBox.x, battleBox.y, battleBox.w, battleBox.h);
      
      if(safeZone){
        ctx.save();
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = 8;
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#00FF00';
        const pulse = safeZone.r + Math.sin(Date.now() / 200) * 5;
        ctx.beginPath();
        ctx.arc(safeZone.x, safeZone.y, pulse, 0, Math.PI * 2);
        ctx.stroke();
        ctx.fillStyle = 'rgba(0, 255, 0, 0.15)';
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#00FF00';
        ctx.font = 'bold 16px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('ZONA SEGURA', safeZone.x, safeZone.y);
        ctx.restore();
      }
      
      if(expandCircle){
        ctx.save();
        ctx.strokeStyle = '#FF0000';
        ctx.lineWidth = 20;
        ctx.shadowBlur = 30;
        ctx.shadowColor = '#FF0000';
        ctx.beginPath();
        ctx.arc(expandCircle.x, expandCircle.y, expandCircle.r, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();
      }
      
      boss.animFrame = (boss.animFrame + 0.15) % (Math.PI * 2);
      const fy = boss.battleY + Math.sin(boss.animFrame) * 8;
      
      ctx.save();
      ctx.translate(boss.battleX, fy);
      ctx.scale(2.5, 2.5);
      drawChar(ctx, -14, -48, boss.colors, 1);
      ctx.fillStyle = '#8B0000';
      ctx.fillRect(18, -10, 6, 30);
      ctx.restore();
      
      projectiles.forEach(p => {
        ctx.save();
        
        if(p.type === 'paper'){
          ctx.translate(p.x + p.w/2, p.y + p.h/2);
          ctx.rotate(p.rot);
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.strokeRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.strokeStyle = '#3498db';
          ctx.lineWidth = 1;
          for(let i = 0; i < 4; i++){
            ctx.beginPath();
            ctx.moveTo(-p.w/2 + 4, -p.h/2 + 6 + i * 6);
            ctx.lineTo(p.w/2 - 4, -p.h/2 + 6 + i * 6);
            ctx.stroke();
          }
        } else if(p.type === 'lightning'){
          ctx.fillStyle = p.flash < 4 ? '#FFFF00' : '#FFA500';
          ctx.shadowBlur = 15;
          ctx.shadowColor = '#FFFF00';
          const w = p.w, h = p.h;
          if(p.dir < 4){
            ctx.fillRect(p.x, p.y, w, h);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(p.x + w*0.3, p.y, w*0.4, h);
          } else {
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x + w, p.y + h);
            ctx.lineTo(p.x + w*0.7, p.y + h*0.5);
            ctx.lineTo(p.x + w, p.y);
            ctx.lineTo(p.x, p.y + h);
            ctx.lineTo(p.x + w*0.3, p.y + h*0.5);
            ctx.closePath();
            ctx.fill();
          }
          ctx.shadowBlur = 0;
        } else if(p.type === 'clock'){
          ctx.translate(p.x + p.w/2, p.y + p.h/2);
          ctx.rotate(p.rot);
          ctx.fillStyle = '#E8E8E8';
          ctx.beginPath();
          ctx.arc(0, 0, p.w/2, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#2C2C2C';
          ctx.lineWidth = 3;
          ctx.stroke();
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(0, -p.w/3);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(p.w/4, 0);
          ctx.stroke();
          ctx.fillStyle = '#000';
          ctx.beginPath();
          ctx.arc(0, 0, 2, 0, Math.PI * 2);
          ctx.fill();
        } else if(p.type === 'desk'){
          ctx.translate(p.x + p.w/2, p.y + p.h/2);
          ctx.rotate(p.rot);
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.fillStyle = '#654321';
          ctx.fillRect(-p.w/2, -p.h/2 + p.h*0.6, p.w, p.h*0.4);
          ctx.strokeStyle = '#5C3317';
          ctx.lineWidth = 2;
          ctx.strokeRect(-p.w/2 + 2, -p.h/2 + 2, p.w - 4, p.h*0.5 - 2);
        } else if(p.type === 'computer'){
          ctx.fillStyle = '#2C2C2C';
          ctx.fillRect(p.x, p.y, p.w, p.h);
        } else if(p.type === 'coffee'){
          ctx.translate(p.x + p.w/2, p.y + p.h/2);
          ctx.rotate(p.rot);
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        } else if(p.type === 'medkit'){
          const pulse = 2 + Math.sin(p.pulse) * 3;
          ctx.shadowBlur = 15;
          ctx.shadowColor = '#00FF00';
          ctx.fillStyle = '#FFF';
          ctx.fillRect(p.x - pulse/2, p.y - pulse/2, p.w + pulse, p.h + pulse);
          ctx.fillStyle = '#FF0000';
          const cw = p.w * 0.6, ch = p.h * 0.2;
          ctx.fillRect(p.x + p.w/2 - cw/2, p.y + p.h/2 - ch/2, cw, ch);
          ctx.fillRect(p.x + p.w/2 - ch/2, p.y + p.h/2 - cw/2, ch, cw);
          ctx.shadowBlur = 0;
        }
        
        ctx.restore();
      });
      
      if(battlePhase === 'attacking'){
        const x = soul.x, y = soul.y, sz = soul.size;
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00FFFF';
        ctx.fillStyle = '#00FFFF';
        ctx.beginPath();
        ctx.moveTo(x, y - sz/4);
        ctx.bezierCurveTo(x - sz/2, y - sz/2, x - sz/2, y, x, y + sz/3);
        ctx.bezierCurveTo(x + sz/2, y, x + sz/2, y - sz/2, x, y - sz/4);
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }

    function gameLoop(){
      if(countdownActive){
        updateCountdown();
      } else if(gameState === 'exploration'){
        updatePlayer();
      } else if(gameState === 'battle'){
        updateSoul();
        updateAttacks();
      }
      
      draw();
      requestAnimationFrame(gameLoop);
    }

    function init(){
      console.log('üõí CoopPlay iniciado');
      
      // Posicionar personajes en lugares visibles
      player.x = W * 0.2;
      player.y = H * 0.65;
      
      boss.x = W * 0.7;
      boss.y = H * 0.65;
      
      updateHealthBars();
      gameLoop();
    }
// ====== CONTROLES M√ìVILES ======
function detectMobile(){
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
  if(isMobile){
    document.getElementById('mobileControls').classList.add('show');
  }
}

function setupMobileControls(){
  const mapping = {
    btnW: 'w',
    btnA: 'a',
    btnS: 's',
    btnD: 'd',
    btnE: 'e',
    btnEnter: 'Enter'
  };

  Object.keys(mapping).forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    const key = mapping[id];

    function press(){
      keys[key] = true;
      keys[key.toLowerCase()] = true;
      el.classList.add('pressed');
      if(key === 'e' && gameState === 'exploration'){
        checkBossInteraction();
      }
    }
    
    function release(){
      keys[key] = false;
      keys[key.toLowerCase()] = false;
      el.classList.remove('pressed');
    }

    el.addEventListener('touchstart', (e) => { e.preventDefault(); press(); });
    el.addEventListener('touchend', (e) => { e.preventDefault(); release(); });
    el.addEventListener('touchcancel', (e) => { e.preventDefault(); release(); });
    el.addEventListener('mousedown', (e) => { e.preventDefault(); press(); });
    el.addEventListener('mouseup', (e) => { e.preventDefault(); release(); });
    el.addEventListener('mouseleave', (e) => { release(); });
  });
}

// LLAMAR LAS FUNCIONES AL FINAL DE INIT()
// Busca tu funci√≥n init() y agrega estas dos l√≠neas AL FINAL (antes del √∫ltimo })
// detectMobile();
// setupMobileControls();

// O SI NO ENCUENTRAS INIT, pega esto justo antes de window.addEventListener('load', init);
(function(){
  const originalInit = window.init || function(){};
  window.init = function(){
    originalInit();
    detectMobile();
    setupMobileControls();
  };
})();
    window.addEventListener('load', init);
  </script>
  <div id="mobileControls">
  <div class="mobile-left">
    <div class="dpad">
      <div id="btnW" class="mobile-btn">W</div>
      <div id="btnA" class="mobile-btn">A</div>
      <div id="btnS" class="mobile-btn">S</div>
      <div id="btnD" class="mobile-btn">D</div>
    </div>
  </div>

  <div class="mobile-right">
    <div style="height:8px;"></div>
    <div id="btnE" class="mobile-btn">E</div>
    <div style="flex:1;"></div>
    <div id="btnEnter" class="mobile-btn">ENTER</div>
  </div>
</div>
</body>
</html>